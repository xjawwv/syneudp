generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  USER
  ADMIN
}

model User {
  id        String    @id @default(cuid())
  email     String    @unique
  role      Role      @default(USER)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  wallet    Wallet?
  instances Instance[]
  deposits  Deposit[]
}

model Wallet {
  id        String        @id @default(cuid())
  userId    String        @unique
  user      User          @relation(fields: [userId], references: [id])
  balance   Decimal       @default(0) @db.Decimal(18, 6)
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  ledger    LedgerEntry[]
}

model LedgerEntry {
  id          String   @id @default(cuid())
  walletId    String
  wallet      Wallet   @relation(fields: [walletId], references: [id])
  type        String
  amount      Decimal  @db.Decimal(18, 6)
  description String
  referenceId String?
  createdAt   DateTime @default(now())
}

model Deposit {
  id          String    @id @default(cuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id])
  amount      Decimal   @db.Decimal(18, 6)
  status      String    @default("pending")
  createdAt   DateTime  @default(now())
  confirmedAt DateTime?
}

model Product {
  id          String     @id @default(cuid())
  name        String
  engine      String
  tier        String
  ratePerHour Decimal    @db.Decimal(18, 6)
  description String
  createdAt   DateTime   @default(now())
  instances   Instance[]
}

model Instance {
  id                  String        @id @default(cuid())
  userId              String
  user                User          @relation(fields: [userId], references: [id])
  productId           String
  product             Product       @relation(fields: [productId], references: [id])
  name                String?
  engine              String
  status              String        @default("provisioning")
  dbName              String
  dbUser              String
  dbPasswordEncrypted String
  host                String
  port                Int
  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt
  terminatedAt        DateTime?
  lastBilledAt        DateTime      @default(now())
  allowedIPs          AllowedIP[]
  usageRecords        UsageRecord[]
}

model AllowedIP {
  id         String   @id @default(cuid())
  instanceId String
  instance   Instance @relation(fields: [instanceId], references: [id])
  ip         String
  createdAt  DateTime @default(now())
}

model UsageRecord {
  id              String   @id @default(cuid())
  instanceId      String
  instance        Instance @relation(fields: [instanceId], references: [id])
  startTime       DateTime
  endTime         DateTime
  durationSeconds Int
  ratePerHour     Decimal  @db.Decimal(18, 6)
  amount          Decimal  @db.Decimal(18, 6)
  createdAt       DateTime @default(now())
}
